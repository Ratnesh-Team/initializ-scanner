name: CI/CD Pipeline with Grype

on: [push]
jobs:
 vulnerability_scanning:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Pull alpine:latest
      run: docker pull alpine:latest

    - name: Install grype
      run: |
        bash
        curl -sL https://github.com/anchore/grype/releases/download/v0.13.0/grype_0.13.0_linux_amd64.tar.gz | tar -xz -C /tmp
        sudo mv /tmp/grype /usr/local/bin
        sudo chmod +x /usr/local/bin/grype

    - name: Install pymongo
      run: pip install pymongo

    - name: Run grype and store the output in MongoDB
      run: |
       bash
       grype alpine:latest -o json > grype-report.json
       cat grype-report.json
       mongoimport --uri="mongodb+srv://ratnesh:ratnesh@cluster0.3ka0uom.mongodb.net/cve_db?retryWrites=true&w=majority" --collection=cve_list --file=grype-report.json --jsonArray || echo "StatusCode=422" > statuscode.txt
